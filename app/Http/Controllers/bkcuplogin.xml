<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use App\Models\Mahasiswa;
use App\Models\Dosen;
use App\Models\Admin;

class LoginController extends Controller
{
    public function showLoginForm()
    {
        return view('auth.login');
    }

    public function login(Request $request)
    {
        $request->validate([
            'login_id' => 'required|string',
            'password' => 'required|string',
        ]);

        $loginId = $request->input('login_id');
        $password = $request->input('password');
        $userType = $request->input('user_type');

        $user = null;

        // Cari user berdasarkan tipe
        switch ($userType) {
            case 'mahasiswa':
                $user = Mahasiswa::where('NIM', $loginId)->first();
                break;
            case 'dosen':
                $user = Dosen::where('NIP', $loginId)->first();
                break;
            case 'admin':
                $user = Admin::where('username', $loginId)->first();
                break;
        }

        // Verifikasi password
        if ($user && Hash::check($password, $user->getAuthPassword())) {
    // Tentukan kolom nama berdasarkan tipe user
    $userName = '';
    switch ($userType) {
        case 'admin':
            $userName = $user->nama_lengkap;
            break;
        case 'dosen':
        case 'mahasiswa':
            $userName = $user->Nama;
            break;
    }

    // Simpan data user ke session
    session([
        'user_type' => $userType,
        'user_id' => $user->getKey(),
        'user_name' => $userName, // <-- Gunakan variabel yang sudah disesuaikan
        'user_data' => $user,
        'is_logged_in' => true
    ]);
            // Redirect berdasarkan tipe user sesuai route yang ada
            switch ($userType) {
                case 'mahasiswa':
                    return redirect()->route('dashboard-mhs'); // ke /dashboard-mhs
                case 'dosen':
                    return redirect()->route('dashboard-dosen'); // ke /dashboard-dosen
                case 'admin':
                    return redirect()->route('dashboard-admin'); // ke /dashboard-admin
                default:
                    return redirect()->route('auth/login');
            }
        }

        // Login gagal
        return back()
            ->withInput($request->only('login_id'))
            ->withErrors(['login_id' => 'Username/NIM/NIP atau password salah!']);
    }

    public function logout(Request $request)
    {
        session()->flush();
        return redirect()->route('login')->with('success', 'Berhasil logout.');
    }
}